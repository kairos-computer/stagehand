commit 70727f384d2b4413b0768b8f821c3e51678e9e16
Author: LOLIPOP-INTELLIGENCE <manaslegodesigns@gmail.com>
Date:   Thu Dec 4 13:33:02 2025 -0800

    adds retry for gemini undefined

diff --git a/packages/core/lib/v3/agent/GoogleCUAClient.ts b/packages/core/lib/v3/agent/GoogleCUAClient.ts
index fb746296..79e8da5b 100644
--- a/packages/core/lib/v3/agent/GoogleCUAClient.ts
+++ b/packages/core/lib/v3/agent/GoogleCUAClient.ts
@@ -294,8 +294,8 @@ export class GoogleCUAClient extends AgentClient {
       const compressedHistory = compressedResult.items;
 
       // Use the SDK's generateContent method with retry logic (matching Python's get_model_response)
-      const maxRetries = 5;
-      const baseDelayS = 1;
+      const maxRetries = 20;
+      const delayMs = 1000;
       let lastError: Error | null = null;
       let response: GenerateContentResponse | null = null;
 
@@ -303,13 +303,12 @@ export class GoogleCUAClient extends AgentClient {
         try {
           // Add exponential backoff delay for retries
           if (attempt > 0) {
-            const delay = baseDelayS * Math.pow(2, attempt) * 1000; // Convert to ms
             logger({
               category: "agent",
-              message: `Generating content failed on attempt ${attempt + 1}. Retrying in ${delay / 1000} seconds...`,
+              message: `Generating content failed on attempt ${attempt + 1}/${maxRetries}. Retrying in 1 second...`,
               level: 2,
             });
-            await new Promise((resolve) => setTimeout(resolve, delay));
+            await new Promise((resolve) => setTimeout(resolve, delayMs));
           }
 
           // Use the SDK's generateContent method - following Python SDK pattern
@@ -324,6 +323,14 @@ export class GoogleCUAClient extends AgentClient {
             throw new LLMResponseError("agent", "Response has no candidates!");
           }
 
+          const candidate = response.candidates[0];
+          if (!candidate.content?.parts) {
+            throw new LLMResponseError(
+              "agent",
+              "Response candidate has malformed content structure (missing content.parts)"
+            );
+          }
+
           // Success - we have a valid response
           break;
         } catch (error) {
